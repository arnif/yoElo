"use strict";angular.module("yoEloApp",["ngCookies","ngResource","ngSanitize","ngRoute","ui.tree","ui.bootstrap"]).config(["$routeProvider","$locationProvider","$httpProvider",function(a,b,c){a.when("/",{templateUrl:"partials/main",controller:"MainCtrl"}).when("/login",{templateUrl:"partials/login",controller:"LoginCtrl"}).when("/signup",{templateUrl:"partials/signup",controller:"SignupCtrl"}).when("/settings",{templateUrl:"partials/settings",controller:"SettingsCtrl",authenticate:!0}).when("/game/:gameId",{templateUrl:"partials/game",controller:"GameCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode(!0),c.interceptors.push(["$q","$location",function(a,b){return{responseError:function(c){return 401===c.status?(b.path("/login"),a.reject(c)):a.reject(c)}}}])}]).run(["$rootScope","$location","Auth",function(a,b,c){a.$on("$routeChangeStart",function(a,d){d.authenticate&&!c.isLoggedIn()&&b.path("/login")})}]),angular.module("yoEloApp").controller("MainCtrl",["$scope","$http",function(a,b){b.get("/api/awesomeThings").success(function(b){a.awesomeThings=b})}]),angular.module("yoEloApp").controller("NavbarCtrl",["$scope","$location","$http","Auth",function(a,b,c,d){function e(){$("#site-wrapper").hasClass("show-nav")?$("#site-wrapper").removeClass("show-nav"):$("#site-wrapper").addClass("show-nav")}function f(){c.get("/api/games").success(function(b){a.menu=b})}a.logout=function(){d.logout().then(function(){b.path("/login")})},a.showGame=function(a){b.path("/game/"+a)},a.isActive=function(a){return"/game/"+a===b.path()},$(".toggle-nav").click(function(){console.log("click"),e()}),f(),a.addGame=function(){c.post("/api/games",{name:a.gameName,players:[]}).success(function(b){console.log(b),a.gameName="",f()})}}]),angular.module("yoEloApp").controller("LoginCtrl",["$scope","Auth","$location",function(a,b,c){a.user={},a.errors={},a.login=function(d){a.submitted=!0,d.$valid&&b.login({email:a.user.email,password:a.user.password}).then(function(){c.path("/")}).catch(function(b){b=b.data,a.errors.other=b.message})}}]),angular.module("yoEloApp").controller("SignupCtrl",["$scope","Auth","$location",function(a,b,c){a.user={},a.errors={},a.register=function(d){a.submitted=!0,d.$valid&&b.createUser({name:a.user.name,email:a.user.email,password:a.user.password}).then(function(){c.path("/")}).catch(function(b){b=b.data,a.errors={},angular.forEach(b.errors,function(b,c){d[c].$setValidity("mongoose",!1),a.errors[c]=b.message})})}}]),angular.module("yoEloApp").controller("SettingsCtrl",["$scope","User","Auth",function(a,b,c){a.errors={},a.changePassword=function(b){a.submitted=!0,b.$valid&&c.changePassword(a.user.oldPassword,a.user.newPassword).then(function(){a.message="Password successfully changed."}).catch(function(){b.password.$setValidity("mongoose",!1),a.errors.other="Incorrect password"})}}]),angular.module("yoEloApp").controller("GameCtrl",["$scope","$http","$routeParams","$modal","$filter",function(a,b,c,d,e){function f(d){console.log(d),b.get("/api/games/"+c.gameId).success(function(b){if(console.log(b),a.game=b,a.playerList=b.players,void 0!==d)for(var c=0;c<a.playerList.length;c++)for(var e=0;e<d.length;e++)a.playerList[c].email===d[e].email&&(a.playerList[c].eloChange=d[e].eloChange);a.order("-score",!1)})}function g(d){console.log("winners array"),console.log(d);var e=d;angular.forEach(e,function(a,d){var f=0,g=e.slice(0,d),h=e.slice(d+1);angular.forEach(g,function(b){f+=i(a,b,!1)}),angular.forEach(h,function(b){f+=i(a,b,!0)});var j=a.score;a.score+=f,a.gamesPlayed+=1,a.eloChange=0>f?f:"+"+f,console.log(a.email,0>f?"loses":"gains",f,"points",j,"->",a.score," games played: ",a.gamesPlayed),b.put("/api/games/score/"+c.gameId,a).success(function(a){console.log(a)})}),f(d),a.winners=[]}a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"];var h=e("orderBy");f(),a.order=function(b,c){a.playerList=h(a.playerList,b,c)},a.winners=[];var i=function(a,b,c){var d=c?1:0,e=j(a),f=k(a.score,b.score);return Math.round(e*(d-f))},j=function(a){var b=a.score;return 2100>b?32:2400>b?24:16},k=function(a,b){var c=Math.pow(10,a/400),d=Math.pow(10,b/400);return c/(c+d)};a.open=function(b){var e=d.open({templateUrl:"myModalContent.html",controller:l,size:b,resolve:{players:function(){return a.playerList},gameId:function(){return c.gameId}}});e.result.then(function(b){console.log(b),"new"===b?setTimeout(function(){a.open()},200):g(b)})};var l=function(a,c,d,e){function g(d){console.log("Add");var g={email:d,score:1500,gamesPlayed:0,eloChange:0};h(d)?(b.put("/api/games/"+e,g).success(function(a){console.log(a),"OK"===a&&(f(),c.close("new"))}),a.errorMsg=""):(a.errorMsg="Not valid email",console.log("ekki email"))}function h(a){var b=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return b.test(a)}a.winners=[],a.playerList=d,a.selected=void 0,console.log(e),a.ok=function(){c.close(a.winners)},a.cancel=function(){c.dismiss("cancel")},a.addToWinners=function(){var b=!1,c=$("#selectedPlayer").val();if(console.log(c),h(c)){for(var d=0;d<a.playerList.length;d++)if(a.playerList[d].email===c){b=!0,console.log("add to winners"),a.winners.push(a.playerList[d]);break}b||confirm("Player not found do you wish to add "+c+"?")&&(console.log("add "),g(c)),a.errorMsg=""}else a.errorMsg="Not valid email",console.log("not valid email");$("#selectedPlayer").val("")}}}]),angular.module("yoEloApp").factory("Auth",["$location","$rootScope","Session","User","$cookieStore",function(a,b,c,d,e){return b.currentUser=e.get("user")||null,e.remove("user"),{login:function(a,d){var e=d||angular.noop;return c.save({email:a.email,password:a.password},function(a){return b.currentUser=a,e()},function(a){return e(a)}).$promise},logout:function(a){var d=a||angular.noop;return c.delete(function(){return b.currentUser=null,d()},function(a){return d(a)}).$promise},createUser:function(a,c){var e=c||angular.noop;return d.save(a,function(a){return b.currentUser=a,e(a)},function(a){return e(a)}).$promise},changePassword:function(a,b,c){var e=c||angular.noop;return d.update({oldPassword:a,newPassword:b},function(a){return e(a)},function(a){return e(a)}).$promise},currentUser:function(){return d.get()},isLoggedIn:function(){var a=b.currentUser;return!!a}}}]),angular.module("yoEloApp").factory("Session",["$resource",function(a){return a("/api/session/")}]),angular.module("yoEloApp").factory("User",["$resource",function(a){return a("/api/users/:id",{id:"@id"},{update:{method:"PUT",params:{}},get:{method:"GET",params:{id:"me"}}})}]),angular.module("yoEloApp").directive("mongooseError",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){b.on("keydown",function(){return d.$setValidity("mongoose",!0)})}}}),angular.module("yoEloApp").directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter,{event:b})}),b.preventDefault())})}}),angular.module("yoEloApp").directive("focus",["$timeout",function(a){return{scope:{trigger:"@focus"},link:function(b,c){b.$watch("trigger",function(b){"true"===b&&a(function(){c[0].focus()})})}}}]);